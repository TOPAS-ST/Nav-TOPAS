
Documentation()

OnInsert()

OnModify()

OnDelete()
ServiceLizenzTab.RESET;
ServiceLizenzTab.SETFILTER(Art,'%1',ServiceLizenzTab.Art :: Temporär);
ServiceLizenzTab.SETFILTER("Nr.",'%1',"Belegnr.");
ServiceLizenzTab.SETFILTER("Belegzeilennr.",'%1',"Belegzeilennr.");
ServiceLizenzTab.SETFILTER("Auftragsnr.",'%1',"Nr.");
ServiceLizenzTab.SETFILTER("Auftragszeilennr.",'%1',"Zeilennr.");
IF ServiceLizenzTab.FINDFIRST THEN
  ServiceLizenzTab.DELETEALL;

OnRename()

Art - OnValidate()

Art - OnLookup()

Nr. - OnValidate()

Nr. - OnLookup()

Zeilennr. - OnValidate()

Zeilennr. - OnLookup()

SUP Artikelnr. - OnValidate()

SUP Artikelnr. - OnLookup()

Geräte Artikelnr. - OnValidate()
IF Art = Art :: "SUP-AU" THEN
  BEGIN

    //Prüfung: Bei Fremderwerb müssen für ein und derselben Pseudo Belegnr. + Zeilennr. die Artikelnummern identisch sein
    IF Fremderwerb = TRUE THEN
      BEGIN
        ServiceZuordnungBeleg.RESET;
        ServiceZuordnungBeleg.SETFILTER(Art,'%1',ServiceZuordnungBeleg.Art :: "SUP-AU");
        ServiceZuordnungBeleg.SETFILTER("Belegnr.",'%1',"Belegnr.");
        ServiceZuordnungBeleg.SETFILTER("Belegzeilennr.",'%1',"Belegzeilennr.");
        IF ServiceZuordnungBeleg.FINDFIRST THEN
          REPEAT 
            IF ((ServiceZuordnungBeleg."Nr." <> "Nr.") OR (ServiceZuordnungBeleg."Zeilennr." <> "Zeilennr."))
            AND (ServiceZuordnungBeleg."Geräte Artikelnr." <> "Geräte Artikelnr.") THEN
              ERROR(Text004,FIELDCAPTION("Belegnr."),ServiceZuordnungBeleg."Belegnr.",FIELDCAPTION("Belegzeilennr."),
                    ServiceZuordnungBeleg."Belegzeilennr.",FIELDCAPTION("Geräte Artikelnr."),
                    ServiceZuordnungBeleg."Geräte Artikelnr.",ServiceZuordnungBeleg."Nr.","Geräte Artikelnr.");
          UNTIL ServiceZuordnungBeleg.NEXT = 0;
      END;

    Artikel.GET("Geräte Artikelnr.");
    IF Artikel.Serviceklassifizierung = '' THEN ERROR(Text000,"Geräte Artikelnr.");
    IF (Artikel.Serviceklassifizierung = 'SYSTEM CHAMPS')
    OR (Artikel.Serviceklassifizierung = 'SYSTEM FLAT') THEN
      Basisgerät := TRUE
    ELSE
      Basisgerät := FALSE;

    "Service VK-Preis einzeln" := 0;
    "Service VK-Preis Zeilenbetrag" := 0;
    "Service DC einzeln" := 0;
    "Service DC Gesamt" := 0;
    "MSRP Service" := 0;

    IF (("Belegnr." <> '') AND ("Belegzeilennr." <> 0)) THEN
      Gruppierung := Gruppieren("Belegnr.","Belegzeilennr.",Basisgerät);

    //Re Instatement Fee soll für Arikelpositionen aus dem Auftrag unterbunden werden
    Artikel.GET("SUP Artikelnr.");
    IF (STRPOS(Artikel."No. 2",'INSTATEMENT') <> 0) AND (STRPOS(Artikel."No. 2",'FEE') <> 0) THEN
      BEGIN
        Auftrag.RESET;
        Auftrag.SETRANGE(Auftrag."No.","Belegnr.");
        IF Auftrag.FINDFIRST THEN
          BEGIN
            ERROR(Text006);
          END;
      END;

  END;

Geräte Artikelnr. - OnLookup()

Abw. Geräte Artikelnr. - OnValidate()

Abw. Geräte Artikelnr. - OnLookup()

Basisgerät - OnValidate()

Basisgerät - OnLookup()

Belegnr. - OnValidate()
Gruppierung := Gruppieren("Belegnr.","Belegzeilennr.",Basisgerät)

Belegnr. - OnLookup()

Belegzeilennr. - OnValidate()
Gruppierung := Gruppieren("Belegnr.","Belegzeilennr.",Basisgerät)

Belegzeilennr. - OnLookup()

Debitornr. - OnValidate()

Debitornr. - OnLookup()

Wartungsvertragsnr. - OnValidate()

Wartungsvertragsnr. - OnLookup()

Vertragsnr. übernommen - OnValidate()

Vertragsnr. übernommen - OnLookup()

Service VK-Preis einzeln - OnValidate()

Service VK-Preis einzeln - OnLookup()

Service VK-Preis Zeilenbetrag - OnValidate()

Service VK-Preis Zeilenbetrag - OnLookup()

Menge kalk. - OnValidate()
IF xRec."Menge kalk." <> "Menge kalk." THEN
  BEGIN
    "Service VK-Preis Zeilenbetrag" := 0;
    "Service DC Gesamt" := 0;
  END;

Menge kalk. - OnLookup()

Laufzeit - OnValidate()
PrüfeServiceQuote(Laufzeit,"Quotenr.");

IF STRPOS(Laufzeit,'M') = 0 THEN
  ERROR('Im Feld %1 muss auch immer die Angabe M (Monate) enthalten sein.',FIELDCAPTION(Laufzeit));

IF xRec.Laufzeit <> Laufzeit THEN
  BEGIN
    "Service VK-Preis einzeln" := 0;
    "Service VK-Preis Zeilenbetrag" := 0;  
    "Service DC einzeln" := 0;
    "Service DC Gesamt" := 0;
    "Rabatt/Marge" := 0;
  END;

//VALIDATE(Startdatum);

Laufzeit - OnLookup()

Startdatum - OnValidate()
IF "SUP Artikelnr." = 'EXTD-HW-WARR/YR' THEN ERROR(Text005);

ServiceZuordnungBeleg.RESET;
ServiceZuordnungBeleg.SETRANGE(Art,ServiceZuordnungBeleg.Art :: "SUP-AU");
ServiceZuordnungBeleg.SETRANGE("Nr.","Nr.");
ServiceZuordnungBeleg.SETRANGE("Zeilennr.","Zeilennr.");
ServiceZuordnungBeleg.SETRANGE(Startdatum,Startdatum);
IF NOT ServiceZuordnungBeleg.FINDFIRST THEN
  BEGIN
    IF (Startdatum < WORKDATE) AND (Startdatum <> 0D) THEN
      IF NOT CONFIRM(Text002,TRUE,FIELDCAPTION(Startdatum)) THEN
        BEGIN
          Startdatum := xRec.Startdatum;
          EXIT;
        END;
  END;

//2015-12-11 ST Zusatz Berechnung der Re Instatement Fee Monate
Artikel.GET("SUP Artikelnr.");
IF Artikel.Artikelgruppe = 'CHAMPS_FEE' THEN
  BEGIN
    champs_fee_monate := TOPAS_API.CalculateTimeDiff('M',Startdatum,WORKDATE);
    IF champs_fee_monate < 3 THEN
      champs_fee_monate := 0
    ELSE
      IF champs_fee_monate > 36 THEN
        champs_fee_monate := 36;
    VALIDATE(Laufzeit, FORMAT(champs_fee_monate)+ 'M');
  END
ELSE
  VALIDATE(Ablaufdatum);

Startdatum - OnLookup()

Ablaufdatum - OnValidate()
IF "SUP Artikelnr." = 'EXTD-HW-WARR/YR' THEN ERROR(Text005);

Artikel.GET("SUP Artikelnr.");
IF Artikel.Artikelgruppe = 'CHAMPS_FEE' THEN
  ERROR(Text007,FIELDCAPTION(Ablaufdatum),FIELDCAPTION(Startdatum));

IF ((Ablaufdatum < WORKDATE) OR (Ablaufdatum < Startdatum)) AND (Ablaufdatum <> 0D) THEN
  ERROR(Text003,FIELDCAPTION(Ablaufdatum));

//IF (xRec.Startdatum <> 0D) AND (Ablaufdatum = 0D) THEN
//  Startdatum := 0D;

//IF (Laufzeit <> '') AND (Startdatum <> 0D) THEN
//  Ablaufdatum := CALCDATE(Laufzeit,Startdatum);

IF Ablaufdatum <> 0D THEN
  VALIDATE(Laufzeit,FORMAT(TOPAS_API.CalculateTimeDiff('M',Startdatum,Ablaufdatum)) + 'M');

IF Startdatum = 0D THEN
  Ablaufdatum := 0D;

IF (Ablaufdatum = 0D) AND (Startdatum = 0D) THEN
  BEGIN
    Opt.RESET;
    Opt.SETFILTER("Tabellen ID",'%1',50024);
    Opt.SETFILTER("Feld ID",'%1',44);
    Opt.SETFILTER("Nr.",'%1',"SUP Artikelnr.");
    IF Opt.FINDFIRST THEN
      VALIDATE(Laufzeit,Opt.Code);
  END;

Ablaufdatum - OnLookup()

Nachträgliche Service Order - OnValidate()

Nachträgliche Service Order - OnLookup()

Fremderwerb - OnValidate()

Fremderwerb - OnLookup()

Service DC einzeln - OnValidate()

Service DC einzeln - OnLookup()

Service DC Gesamt - OnValidate()

Service DC Gesamt - OnLookup()

MSRP Service - OnValidate()

MSRP Service - OnLookup()

Service DC Währungscode - OnValidate()

Service DC Währungscode - OnLookup()

Rabatt/Marge - OnValidate()

Rabatt/Marge - OnLookup()

Laufzeit ab Buchungsdatum - OnValidate()

Laufzeit ab Buchungsdatum - OnLookup()

Quotenr. - OnValidate()
PrüfeServiceQuote(Laufzeit,"Quotenr.");

Quotenr. - OnLookup()

Gruppierung - OnValidate()

Gruppierung - OnLookup()

PseudoBelegNrErmitteln(auftragsnr : Code[20];auzeilennr : Integer) : Code[20]
PrüfeServRelaDoc.RESET;
PrüfeServRelaDoc.SETFILTER(Art,'%1',PrüfeServRelaDoc.Art :: "SUP-AU");
PrüfeServRelaDoc.SETFILTER("Nr.",'%1',auftragsnr);
PrüfeServRelaDoc.SETFILTER("Zeilennr.",'%1',auzeilennr);
PrüfeServRelaDoc.SETFILTER(Fremderwerb,'%1',TRUE);
IF PrüfeServRelaDoc.FINDFIRST THEN
  BEGIN
    EXIT(PrüfeServRelaDoc."Belegnr.");
  END
ELSE
  BEGIN
    // Prüfe, ob im Beleg eine andere Kalkulation mit Pseudo Belegnr. besteht und wenn ja biete diese an
    PrüfeServRelaDoc.RESET;
    PrüfeServRelaDoc.SETFILTER(Art,'%1',PrüfeServRelaDoc.Art :: "SUP-AU");
    PrüfeServRelaDoc.SETFILTER("Nr.",'%1',auftragsnr);
    //PrüfeServRelaDoc.SETFILTER(Basisgerät,'%1',TRUE);
    PrüfeServRelaDoc.SETFILTER(Fremderwerb,'%1',TRUE);
    IF PrüfeServRelaDoc.FINDLAST THEN
      IF CONFIRM(Text001,TRUE,PrüfeServRelaDoc."Zeilennr.",PrüfeServRelaDoc."SUP Artikelnr.",PrüfeServRelaDoc."Belegnr.") THEN
        EXIT(PrüfeServRelaDoc."Belegnr.");

    ok := EVALUATE(eingabe,'TOPAS-PSEU');
    laufende_nummer:='';
    NoSeriesMgt.InitSeries(eingabe,eingabe,TODAY,laufende_nummer,eingabe);
    EXIT('LS_' + laufende_nummer);
  END;

PrüfeServiceQuote(kalk_laufzeit : Code[20];kalk_quotenr : Code[10])
//Zunächst für AudioCodes Quotes gedacht, gelten grundsätzlich nur für Service-Laufzeiten von max. 1 Jahr
EVALUATE(v_laufzeit,COPYSTR(kalk_laufzeit,1,STRPOS(kalk_laufzeit,'M')-1));
IF (kalk_quotenr <> '') AND (v_laufzeit > 12) THEN
  ERROR(Text008);

Gruppieren(Belegnr : Code[20];Belegzeile : Integer;Basisgerät : Boolean) : Text[50]
IF (Belegnr = '') OR (Belegzeile = 0) THEN
  EXIT;

IF Basisgerät = TRUE THEN
  Teil_string_a := 'B_'
ELSE
  Teil_string_a := 'M_';

//Damit 6 stellige Zeilennr. auch nach unten sortiert werden
zusatz_belegzeile := '';
IF STRLEN(FORMAT(Belegzeile)) >=6 THEN
  zusatz_belegzeile := '6ST_';

IF (STRPOS(Belegnr,'AU') <> 0) OR (STRPOS(Belegnr,'PSEU') <> 0) THEN
  //Ein X_ damit Auftrags- oder Pseudo Positionen nach unten sortiert werden
  Teil_string_b := 'X_' + zusatz_belegzeile + Belegnr + '_' + FORMAT(Belegzeile)
ELSE
  Teil_string_b := zusatz_belegzeile + Belegnr + '_' + FORMAT(Belegzeile);

EXIT(Teil_string_a + Teil_string_b);
